function processPastedData(data) {
    try {
        const rows = data.trim().split('\n');
        if (rows.length < 2) { // Need at least header and one data row
            alert('No data found to import');
            return false;
        }

        // Get and process headers
        const headers = rows[0].split('\t').map(header => header.trim().toLowerCase());
        const headerIndexMap = {
            'equipmenttype': -1,
            'vendor': -1,
            'brandmodel': -1,
            'assetno': -1,
            'serialnumber': -1,
            'enddate': -1,
            'startdate': -1,
            'room': -1,
            'room number': -1,
            'level': -1,
            'lamphour': -1
        };

        // Map header indices
        headers.forEach((header, index) => {
            if (headerIndexMap.hasOwnProperty(header.replace(/\s+/g, ''))) {
                headerIndexMap[header.replace(/\s+/g, '')] = index;
            }
        });

        // Get existing inventory
        const existingInventory = JSON.parse(localStorage.getItem('inventory')) || [];
        const newInventory = [...existingInventory];
        let errorRows = [];
        let updatedCount = 0;
        let addedCount = 0;

        // Process data rows
        for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split('\t').map(col => col.trim());
            if (columns.length < headers.length) {
                errorRows.push(i + 1);
                continue;
            }

            // Create item object with only the fields present in headers
            const item = {};
            let hasData = false;
            
            // Map data according to headers
            if (headerIndexMap.equipmenttype !== -1) {
                item.equipmentType = columns[headerIndexMap.equipmenttype];
                hasData = true;
            }
            if (headerIndexMap.vendor !== -1) {
                item.vendor = columns[headerIndexMap.vendor];
                hasData = true;
            }
            if (headerIndexMap.brandmodel !== -1) {
                item.brandModel = columns[headerIndexMap.brandmodel];
                hasData = true;
            }
            if (headerIndexMap.assetno !== -1) {
                item.assetNo = columns[headerIndexMap.assetno];
                hasData = true;
            }
            if (headerIndexMap.serialnumber !== -1) {
                item.serialNumber = columns[headerIndexMap.serialnumber];
                hasData = true;
            }
            if (headerIndexMap.enddate !== -1) {
                item.endDate = columns[headerIndexMap.enddate];
                hasData = true;
            }
            if (headerIndexMap.startdate !== -1) {
                item.startDate = columns[headerIndexMap.startdate];
                hasData = true;
            }
            if (headerIndexMap.room !== -1) {
                item.room = columns[headerIndexMap.room];
                hasData = true;
            }
            if (headerIndexMap['room number'] !== -1) {
                item.roomNumber = columns[headerIndexMap['room number']];
                hasData = true;
            }
            if (headerIndexMap.level !== -1) {
                item.level = columns[headerIndexMap.level];
                hasData = true;
            }
            if (headerIndexMap.lamphour !== -1) {
                item.lamphour = columns[headerIndexMap.lamphour];
                hasData = true;
            }

            if (!hasData) {
                errorRows.push(i + 1);
                continue;
            }

            // Try to find existing item by Asset No or Serial Number
            const existingItemIndex = newInventory.findIndex(existing => 
                (item.assetNo && existing.assetNo === item.assetNo) || 
                (item.serialNumber && existing.serialNumber === item.serialNumber)
            );

            if (existingItemIndex !== -1) {
                // Update existing item with new data while preserving existing fields
                const updatedItem = { ...newInventory[existingItemIndex] };
                Object.keys(item).forEach(key => {
                    if (item[key]) {
                        updatedItem[key] = item[key];
                    }
                });
                newInventory[existingItemIndex] = updatedItem;
                updatedCount++;
            } else {
                // For new items, ensure all required fields have default values
                const newItem = {
                    equipmentType: item.equipmentType || '',
                    vendor: item.vendor || '',
                    brandModel: item.brandModel || '',
                    assetNo: item.assetNo || '',
                    serialNumber: item.serialNumber || '',
                    endDate: item.endDate || '',
                    startDate: item.startDate || '',
                    room: item.room || '',
                    roomNumber: item.roomNumber || '',
                    level: item.level || '',
                    lamphour: item.lamphour || ''
                };
                newInventory.push(newItem);
                addedCount++;
            }
        }

        if (errorRows.length > 0) {
            alert(`Warning: Rows ${errorRows.join(', ')} have incorrect format and were skipped.`);
        }

        if (updatedCount > 0 || addedCount > 0) {
            localStorage.setItem('inventory', JSON.stringify(newInventory));
            alert(`Update successful!\nUpdated items: ${updatedCount}\nNew items added: ${addedCount}`);
            
            // Close the modal
            const modalElement = document.getElementById('importModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            // Clear inputs
            document.getElementById('fileInput').value = '';
            document.getElementById('dataInput').value = '';

            // Show inventory
            showInventory();
            return true;
        } else {
            alert('No valid data found to import.');
            return false;
        }

    } catch (error) {
        console.error('Error processing pasted data:', error);
        alert('Error processing data. Please check the format and try again.');
        return false;
    }
}
